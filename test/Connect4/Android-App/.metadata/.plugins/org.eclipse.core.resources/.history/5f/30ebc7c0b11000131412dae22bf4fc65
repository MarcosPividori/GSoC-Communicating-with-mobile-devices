package com.example.gsoc_example_connect4;

import java.util.Arrays;

import org.json.JSONArray;
import org.json.JSONException;
import android.content.SharedPreferences;
import android.util.Log;

public class Board {
	
	private Integer[] positions;
	SharedPreferences prefs;
	int turn= 0;
		
	public Board(SharedPreferences pref){
		prefs = pref;
		String actualPlayer = prefs.getString("actualPlayer",null);
		positions = new Integer[42];
		
		if(actualPlayer == null )
			setNewGame();
        else
        	readState();
	}
	
	public void readState(){
		String gameState= prefs.getString("board",null);
        if(gameState == null){
        	setNewGame();Log.i("tag", "OK2");}
        else{
        	try{
        		JSONArray json= new JSONArray(gameState);
           		positions = new Integer[42];
            	for(int i=0;i<42;i++){
            		positions[i] = json.getInt(i);	
            	}
        	}catch(JSONException e){Log.i("tag", "JSON EXCEPTION!!");setNewGame();}
        }
	}
	
	final private Integer[] newGame = {
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty, R.drawable.empty , R.drawable.empty ,
            R.drawable.empty , R.drawable.empty
    };	

	public int getPosition(int pos){
    	return positions[pos];
    }
	
	public void setNewGame(){
		for(int i=0;i<42;i++){
    		positions[i] = newGame[i];	
    	}
		SharedPreferences.Editor editor = prefs.edit();
		JSONArray json = new JSONArray(Arrays.asList(positions));
		editor.putString("board", json.toString());
		editor.commit();
	}
	
	private void setPosition(int pos,int player){
		int color;
		if (player == 1)
			color= R.drawable.red;
		else{
			if (player == 2)
				color= R.drawable.yellow;
			else
				return ;
		}
		positions[pos] = color;
    }
	
	public void newMovement(int column,int player){//column
		if(column > 6 || column <0)
			return ;
		if(turn == player){
    		for(int i=column;i<42;i+=7){
    			if((i<35 && positions[i+7]!=R.drawable.empty) ||  (i>=35)){
					setPosition(i,player);
					break;
    			}
    		}
    		save();
		}
	}
	
	public void cancelMovement(int column){
		if(column > 6 || column <0)
			return ;
		for(int i=column;i<42;i+=7){
			if((i<35 && positions[i+7]!=R.drawable.empty) ||  (i>=35)){
					if(positions[i+7] == R.drawable.red)
						positions[i+7]=R.drawable.empty;
					break;
			}
		}
		save();
	}
	
	public void save(){
		SharedPreferences.Editor editor = prefs.edit();
		JSONArray json = new JSONArray(Arrays.asList(positions));
		editor.putString("board", json.toString());
		editor.commit();
	}
}
